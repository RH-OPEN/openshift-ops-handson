<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: OpenShift Ops Handson</title>
    <link rel="canonical" href="https://rh-open.github.io/openshift-ops-handson/tutorial/07-operator.html">
    <link rel="prev" href="06-machineset.html">
    <link rel="next" href="08-logging.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://rh-open.github.io/openshift-ops-handson">OpenShift Ops Handson</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-env-overview.html">2. Environment Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-installation.html">3. Installation and Verification</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-app-basic.html">4. Application Management Basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-storage-basic.html">5. Application Storage Basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-machineset.html">6. MachineSets, Machines, and Nodes</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="07-operator.html">7. Infrastructure Nodes and Operators</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-logging.html">8. OpenShift Log Aggregation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-auth.html">9. External (LDAP) Authentication Providers, Users, and Groups</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-monitoring.html">10. OpenShift Monitoring with Prometheus</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="11-project.html">11. Project Template, Quota, and Limits</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="12-network.html">12. OpenShift Networking and NetworkPolicy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="13-clusterrolebinding.html">13. Disabling Project Self-Provisioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="14-clusterresourcequota.html">14. Cluster Resource Quotas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="15-taint.html">15. Taints and Tolerations</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Ops Tutorial</a></li>
    <li><a href="07-operator.html">7. Infrastructure Nodes and Operators</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/RH-OPEN/openshift-ops-handson/edit/master/documentation/modules/ROOT/pages/07-operator.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_openshift_infrastructure_nodes"><a class="anchor" href="#_openshift_infrastructure_nodes"></a>OpenShift Infrastructure Nodes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>インフラストラクチャの分類に分類される OpenShift コンポーネントには、次のものがあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>kubernetes and OpenShift control plane services ("masters")</p>
</li>
<li>
<p>router</p>
</li>
<li>
<p>container image registry</p>
</li>
<li>
<p>cluster metrics collection ("monitoring")</p>
</li>
<li>
<p>cluster aggregated logging</p>
</li>
<li>
<p>service brokers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>上記以外のコンテナー/ポッド/コンポーネントを実行しているノードはワーカーと見なされ、サブスクリプションでカバーする必要があります。</p>
</div>
<div class="sect2">
<h3 id="_more_machineset_details"><a class="anchor" href="#_more_machineset_details"></a>More MachineSet Details</h3>
<div class="paragraph">
<p><code>MachineSets</code> の演習では、 <code>MachineSets</code> を使用し、レプリカの数を変更してクラスターをスケーリングする方法について説明しました。 インフラストラクチャ ノードの場合、特定の Kubernetes ラベルを持つ追加の <code>Machines</code> を作成します。 次に、さまざまなインフラストラクチャ コンポーネントを構成して、これらのラベルを持つノードで具体的に実行できます。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>現在、インフラストラクチャ コンポーネントを制御するために使用されるオペレーターは、テイントと容認の使用をすべてサポートしているわけではありません。 これは、インフラストラクチャ ワークロードがインフラストラクチャ ノードに移動することを意味しますが、他のワークロードがインフラストラクチャ ノードでの実行を明確に妨げられるわけではありません。 言い換えれば、すべてのオペレーターに完全な汚染/耐性サポートが実装されるまで、ユーザーのワークロードはインフラストラクチャのワークロードと混ざり合う可能性があります。</p>
</div>
<div class="paragraph">
<p>テイントと容認は連携して機能し、ワークロードが特定のノードにスケジュールされないようにします。 それらは後で調査されます。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>これを実現するには、追加の <code>MachineSets</code> を作成します。</p>
</div>
<div class="paragraph">
<p><code>MachineSets</code> がどのように機能するかを理解するには、次を実行します。</p>
</div>
<div class="paragraph">
<p>これにより、以下の説明のいくつかに沿って進めることができます。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CLUSTERNAME=$(oc get  infrastructures.config.openshift.io cluster  -o jsonpath='{.status.infrastructureName}')
ZONENAME=$(oc get nodes -L topology.kubernetes.io/zone  --no-headers  | awk '{print $NF}' | tail -1)
oc get machineset -n openshift-machine-api -o yaml ${CLUSTERNAME}-worker-${ZONENAME}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_metadata"><a class="anchor" href="#_metadata"></a>Metadata</h4>
<div class="paragraph">
<p><code>MachineSet</code> 自体の <code>metadata</code> には、 <code>MachineSet</code> の名前やさまざまなラベルなどの情報が含まれています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML hljs" data-lang="YAML">metadata:
  creationTimestamp: 2019-01-25T16:00:34Z
  generation: 1
  labels:
    machine.openshift.io/cluster-api-cluster: 190125-3
    machine.openshift.io/cluster-api-machine-role: worker
    machine.openshift.io/cluster-api-machine-type: worker
  name: 190125-3-worker-us-east-1b
  namespace: openshift-machine-api
  resourceVersion: "9027"
  selfLink: /apis/cluster.k8s.io/v1alpha1/namespaces/openshift-machine-api/machinesets/190125-3-worker-us-east-1b
  uid: 591b4d06-20ba-11e9-a880-068acb199400</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="literalblock">
<div class="content">
<pre>`MachineAutoScaler` が定義されているものをダンプした場合、 `MachineSet` に `annotations` が表示される場合があります。</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_selector"><a class="anchor" href="#_selector"></a>Selector</h4>
<div class="paragraph">
<p><code>MachineSet</code> は <code>Machines</code> の作成方法を定義し、<code>Selector</code> はどのマシンがセットに関連付けられているかをオペレーターに伝えます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML hljs" data-lang="YAML">spec:
  replicas: 2
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: 190125-3
      machine.openshift.io/cluster-api-machineset: 190125-3-worker-us-east-1b</code></pre>
</div>
</div>
<div class="paragraph">
<p>この場合、クラスタ名は「190125-3」で、セット全体に追加のラベルがあります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_template_metadata"><a class="anchor" href="#_template_metadata"></a>Template Metadata</h3>
<div class="paragraph">
<p><code>template</code> は <code>Machine</code> をテンプレート化する <code>MachineSet</code> の一部です。 <code>template</code> 自体にメタデータを関連付けることができます。変更を加えるときは、ここで内容が一致していることを確認する必要があります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML hljs" data-lang="YAML">  template:
    metadata: {}
      labels:
        machine.openshift.io/cluster-api-cluster: 190125-3
        machine.openshift.io/cluster-api-machine-role: worker
        machine.openshift.io/cluster-api-machine-type: worker
        machine.openshift.io/cluster-api-machineset: 190125-3-worker-us-east-1b</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_template_spec"><a class="anchor" href="#_template_spec"></a>Template Spec</h4>
<div class="paragraph">
<p><code>template</code> は <code>Machine</code>/<code>Node</code> の作成方法を指定する必要があります。 <code>spec</code>、より具体的には <code>providerSpec</code> には、<code>Machine</code> を正しく作成してブートストラップするのに役立つすべての重要な AWS データが含まれていることに気付くでしょう。</p>
</div>
<div class="paragraph">
<p>この場合、結果のノードが 1 つ以上の特定のラベルを継承するようにします。 上記の例で見たように、ラベルは <code>metadata</code> セクションに入ります:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML hljs" data-lang="YAML">  spec:
      metadata:
        creationTimestamp: null
      providerSpec:
        value:
          ami:
            id: ami-08871aee06d13e584
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>デフォルトでは、インストーラーが作成する <code>MachineSets</code> はノードに追加のラベルを適用しません。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_defining_a_custom_machineset"><a class="anchor" href="#_defining_a_custom_machineset"></a>Defining a Custom MachineSet</h3>
<div class="paragraph">
<p>既存の <code>MachineSet</code> を分析したので、それを作成するためのルールを確認する時が来ました。少なくとも、私たちが行っているような単純な変更については:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>providerSpec</code> は何も変更しないでください</p>
</li>
<li>
<p><code>machine.openshift.io/cluster-api-cluster: &lt;clusterid&gt;</code> のインスタンスを変更しないでください</p>
</li>
<li>
<p><code>MachineSet</code> に一意の <code>name</code> を付けます</p>
</li>
<li>
<p><code>machine.openshift.io/cluster-api-machineset</code> のすべてのインスタンスが <code>name</code> と一致することを確認します</p>
</li>
<li>
<p>ノードに必要なラベルを <code>.spec.template.spec.metadata.labels</code> に追加します</p>
</li>
<li>
<p><code>MachineSet</code> の <code>name</code> 参照を変更していても、<code>subnet</code> は変更しないでください。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>これは複雑に聞こえますが、簡単なスクリプトといくつかの手順を用意して、面倒な作業を自動的に行います。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">bash {{ HOME_PATH }}/support/machineset-generator.sh 1 infra 0 | oc create -f -
export MACHINESET=$(oc get machineset -n openshift-machine-api -l machine.openshift.io/cluster-api-machine-role=infra -o jsonpath='{.items[0].metadata.name}')
oc patch machineset $MACHINESET -n openshift-machine-api --type='json' -p='[{"op": "add", "path": "/spec/template/spec/metadata/labels", "value":{"node-role.kubernetes.io/worker":"", "node-role.kubernetes.io/infra":""} }]'
oc scale machineset $MACHINESET -n openshift-machine-api --replicas=3</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、実行してください：</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get machineset -n openshift-machine-api</code></pre>
</div>
</div>
<div class="paragraph">
<p>次のような名前の新しいインフラ セットが表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">...
cluster-city-56f8-mc4pf-infra-us-east-2a    1         1                             13s
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>インスタンスがまだ起動してブートストラップ中であるため、セット内に準備が整った、または使用可能なマシンはまだありません。 <code>oc get machine -n openshift-machine-api</code> をチェックして、インスタンスが最終的にいつ実行を開始するかを確認できます。 次に、 <code>oc get node</code> を使用して、実際のノードがいつ結合され、準備ができているかを確認できます。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><code>Machine</code> が準備され、 <code>Node</code> として追加されるまでに数分かかる場合があります。</p>
</div>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get nodes</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">NAME                                         STATUS   ROLES          AGE     VERSION
ip-10-0-133-134.us-east-2.compute.internal   Ready    infra,worker   8m     v1.16.2
ip-10-0-133-191.us-east-2.compute.internal   Ready    worker         61m    v1.16.2
ip-10-0-136-83.us-east-2.compute.internal    Ready    master         67m    v1.16.2
ip-10-0-138-24.us-east-2.compute.internal    Ready    infra,worker   8m1s   v1.16.2
ip-10-0-139-81.us-east-2.compute.internal    Ready    infra,worker   8m3s   v1.16.2
ip-10-0-152-132.us-east-2.compute.internal   Ready    worker         61m    v1.16.2
ip-10-0-157-139.us-east-2.compute.internal   Ready    master         67m    v1.16.2
ip-10-0-167-9.us-east-2.compute.internal     Ready    worker         61m    v1.16.2
ip-10-0-169-121.us-east-2.compute.internal   Ready    master         67m    v1.16.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>どのノードが新しいノードか分からない場合は、 <code>AGE</code> 列を見てください。 最年少になります！ また、<code>ROLES</code> 列では、新しいノードに <code>worker</code> と <code>infra</code> の両方の役割があることがわかります。</p>
</div>
<div class="paragraph">
<p>または、役割ごとにノードをリストすることもできます。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get nodes -l node-role.kubernetes.io/infra</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_check_the_labels"><a class="anchor" href="#_check_the_labels"></a>Check the Labels</h3>
<div class="paragraph">
<p>私たちの場合、最も若いノードは <code>ip-10-0-128-138.us-east-1.compute.internal</code> という名前だったので、そのラベルが何であるかを尋ねることができます:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">YOUNG_INFRA_NODE=$(oc get nodes -l node-role.kubernetes.io/infra  --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[0].metadata.name}')
oc get nodes ${YOUNG_INFRA_NODE} --show-labels | grep --color node-role</code></pre>
</div>
</div>
<div class="paragraph">
<p>そして、<code>LABELS</code> 列には次のように表示されます。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=m5.2xlarge,beta.kubernetes.io/os=linux,failure-domain.beta.kubernetes.io/region=us-east-2,failure-domain.beta.kubernetes.io/zone=us-east-2a,kubernetes.io/arch=amd64,kubernetes.io/hostname=ip-10-0-140-3,kubernetes.io/os=linux,node-role.kubernetes.io/infra=,node-role.kubernetes.io/worker=,node.openshift.io/os_id=rhcos</pre>
</div>
</div>
<div class="paragraph">
<p>わかりにくいですが、 <code>node-role.kubernetes.io/infra</code> というラベルがあります。</p>
</div>
</div>
<div class="sect2">
<h3 id="_add_more_machinesets_or_scale_or_both"><a class="anchor" href="#_add_more_machinesets_or_scale_or_both"></a>Add More Machinesets (or scale, or both)</h3>
<div class="paragraph">
<p>現実的な運用展開では、インフラストラクチャ コンポーネントを保持するために少なくとも 3 つの <code>MachineSets</code> が必要です。 ロギング集約ソリューションとサービス メッシュの両方が ElasticSearch をデプロイします。ElasticSearch には、3 つの個別のノードにまたがる 3 つのインスタンスが実際に必要です。 なぜ 3 つの <code>MachineSets</code> なのか? 理論的には、異なる AZ に複数の <code>MachineSets</code> を配置することで、AWS が AZ を失った場合でも完全に暗くなることはありません。</p>
</div>
<div class="paragraph">
<p>スクリプトレットで作成した <code>MachineSet</code> によって、すでに 3 つのレプリカが作成されているので、今のところ何もする必要はありません。 自分で追加のものを作成しないでください。使用しているアカウントの AWS 制限は意図的に小さくなっています。</p>
</div>
</div>
<div class="sect2">
<h3 id="_extra_credit"><a class="anchor" href="#_extra_credit"></a>Extra Credit</h3>
<div class="paragraph">
<p><code>openshift-machine-api</code> プロジェクトには、いくつかの <code>Pod</code> があります。 それらの 1 つは、<code>machine-api-controllers-56bdc6874f-86jnb</code> のような名前を持っています。 その Pod 内のさまざまなコンテナーで oc logs を使用すると、実際にノードを作成するさまざまなオペレーター ビットが表示されます。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quick_operator_background"><a class="anchor" href="#_quick_operator_background"></a>Quick Operator Background</h2>
<div class="sectionbody">
<div class="paragraph">
<p>オペレーターは単なる <code>Pods</code> です。 しかし、それらは特別な <code>Pods</code> です。 これらは、Kubernetes 環境でアプリケーションをデプロイおよび管理する方法を理解するソフトウェアです。 Operator の機能は、<code>CustomResourceDefinitions</code> (<code>CRD</code>) と呼ばれる Kubernetes 機能に依存しています。  <code>CRD</code> はまさにその名のとおりです。 これらは、基本的に新しいオブジェクトで Kubernetes API を拡張するカスタム リソースを定義する方法です。</p>
</div>
<div class="paragraph">
<p>Kubernetes で <code>Foo</code> オブジェクトを作成/読み取り/更新/削除できるようにしたい場合は、 <code>Foo</code> リソースとは何か、およびそれがどのように機能するかを定義する <code>CRD</code> を作成します。 その後、<code>CustomResources</code> (<code>CRs</code>)&#8201;&#8212;&#8201;<code>CRD</code> のインスタンスを作成できます。</p>
</div>
<div class="paragraph">
<p>Operator の場合、一般的なパターンは、Operator がその構成について <code>CRs</code> を参照し、次に Kubernetes 環境で_操作_して、構成で指定されていることを実行するというものです。 ここで、OpenShift の一部のインフラストラクチャ オペレーターがどのように業務を行っているかを見ていきます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_moving_infrastructure_components"><a class="anchor" href="#_moving_infrastructure_components"></a>Moving Infrastructure Components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>いくつかの特別なノードができたので、さまざまなインフラストラクチャ コンポーネントをそれらに移動します。</p>
</div>
<div class="sect2">
<h3 id="_router"><a class="anchor" href="#_router"></a>Router</h3>
<div class="paragraph">
<p>OpenShift ルーターは、 <code>openshift-ingress-operator</code> と呼ばれる <code>Operator</code> によって管理されます。 その <code>Pod</code> は <code>openshift-ingress-operator</code> プロジェクトに存在します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pod -n openshift-ingress-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>実際のデフォルト ルーター インスタンスは <code>openshift-ingress</code> プロジェクトにあります。  <code>Pods</code> を見てください。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n openshift-ingress -o wide</code></pre>
</div>
</div>
<div class="paragraph">
<p>そして、次のようなものが表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">NAME                              READY   STATUS    RESTARTS   AGE   IP           NODE                                        NOMINATED NODE
router-default-7bc4c9c5cd-clwqt   1/1     Running   0          9h    10.128.2.7   ip-10-0-144-70.us-east-2.compute.internal   &lt;none&gt;
router-default-7bc4c9c5cd-fq7m2   1/1     Running   0          9h    10.131.0.7   ip-10-0-138-38.us-east-2.compute.internal   &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>ルーターが実行されている <code>Node</code> を確認します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ROUTER_POD_NODE=$(oc get pods -n openshift-ingress -o jsonpath='{.items[0].spec.nodeName}')
oc get node ${ROUTER_POD_NODE}</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>`worker` の役割を持っていることがわかります。</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">NAME                                        STATUS   ROLES    AGE   VERSION
ip-10-0-144-70.us-east-2.compute.internal   Ready    worker   9h    v1.12.4+509916ce1</code></pre>
</div>
</div>
<div class="paragraph">
<p>ルーター オペレーターのデフォルト設定では、 <code>worker</code> の役割を持つノードを選択します。 しかし、専用のインフラストラクチャ ノードを作成したので、 <code>infra</code> の役割を持つノードにルーター インスタンスを配置するようにオペレーターに伝えたいと考えています。</p>
</div>
<div class="paragraph">
<p>OpenShift ルーター オペレーターは、 <code>ingresses.config.openshift.io</code> と呼ばれるカスタム リソース定義 ( <code>CRD</code> ) を使用して、クラスターのデフォルトのルーティング サブドメインを定義します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get ingresses.config.openshift.io cluster -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>cluster</code> オブジェクトは、ルーター オペレーターとマスターによって監視されます。 あなたのものはおそらく次のようになります：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML hljs" data-lang="YAML">apiVersion: config.openshift.io/v1
kind: Ingress
metadata:
  creationTimestamp: 2019-04-08T14:37:49Z
  generation: 1
  name: cluster
  resourceVersion: "396"
  selfLink: /apis/config.openshift.io/v1/ingresses/cluster
  uid: e1ec463c-5a0b-11e9-93e8-028b0fb1636c
spec:
  domain: {{ ROUTE_SUBDOMAIN }}
status: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>個々のルーターのデプロイメントは、 <code>ingresscontrollers.operator.openshift.io</code> CRD を介して管理されます。 <code>openshift-ingress-operator</code> 名前空間に作成されたデフォルトのものがあります。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get ingresscontrollers.operator.openshift.io default -n openshift-ingress-operator -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>あなたのものは次のようになります：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML hljs" data-lang="YAML">apiVersion: operator.openshift.io/v1
kind: IngressController
metadata:
  creationTimestamp: 2019-04-08T14:46:15Z
  finalizers:
  - ingress.openshift.io/ingress-controller
  generation: 2
  name: default
  namespace: openshift-ingress-operator
  resourceVersion: "2056085"
  selfLink: /apis/operator.openshift.io/v1/namespaces/openshift-ingress-operator/ingresscontrollers/default
  uid: 0fac160d-5a0d-11e9-a3bb-02d64e703494
spec: {}
status:
  availableReplicas: 2
  conditions:
  - lastTransitionTime: 2019-04-08T14:47:14Z
    status: "True"
    type: Available
  domain: apps.cluster-f4a3.f4a3.openshiftworkshop.com
  endpointPublishingStrategy:
    type: LoadBalancerService
  selector: ingress.operator.openshift.io/ingress-controller-deployment=default</code></pre>
</div>
</div>
<div class="paragraph">
<p>ルーター Pod にインフラストラクチャ ノードをヒットするように指示する <code>nodeSelector</code> を指定するには、次の構成を適用できます。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f {{ HOME_PATH }}/support/ingresscontroller.yaml</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><code>Warning: resource is missing the kubectl.kubernetes.io/last-applied-config</code> というエラーが表示される場合があります。 これは正常です。<code>apply</code> は <a href="https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#kubectl-apply">"3 way diff merge"</a> を呼び出します。 イングレス コントローラーはインストール時に作成されたばかりなので、「最後に適用された」構成はありません。 そのコマンドを再度実行すると、その警告は表示されません。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>以下のコマンドを実行します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pod -n openshift-ingress -o wide</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>ルーターの移動中にセッションがタイムアウトする場合があります。 セッションを元に戻すには、ページを更新してください。 端末セッションが失われることはありませんが、手動でこのページに戻る必要がある場合があります。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>速ければ、 <code>Terminating</code> または <code>ContainerCreating</code> ポッドのいずれかをキャッチできます。 「終了」ポッドは、ワーカー ノードの 1 つで実行されていました。  <code>Running</code> のポッドは、最終的に <code>infra</code> ロールを持つノードの 1 つになります。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_registry"><a class="anchor" href="#_registry"></a>Registry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>レジストリは、同様の <code>CRD</code> メカニズムを使用して、オペレーターが実際のレジストリ ポッドをデプロイする方法を構成します。 その CRD は <code>configs.imageregistry.operator.openshift.io</code> です。 <code>nodeSelector</code> を追加するために <code>cluster</code> CR オブジェクトを編集します。 まず、それを見てください：</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get configs.imageregistry.operator.openshift.io/cluster -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>次のようなものが表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML hljs" data-lang="YAML">apiVersion: imageregistry.operator.openshift.io/v1
kind: Config
metadata:
  creationTimestamp: "2019-08-06T13:57:22Z"
  finalizers:
  - imageregistry.operator.openshift.io/finalizer
  generation: 2
  name: cluster
  resourceVersion: "13218"
  selfLink: /apis/imageregistry.operator.openshift.io/v1/configs/cluster
  uid: 1cb6272a-b852-11e9-9a54-02fdf1f6ca7a
spec:
  defaultRoute: false
  httpSecret: fff8bb0952d32e0aa56adf0ac6f6cf5267e0627f7b42e35c508050b5be426f8fd5e5108bea314f4291eeacc0b95a2ea9f842b54d7eb61522238f2a2dc471f131
  logging: 2
  managementState: Managed
  proxy:
    http: ""
    https: ""
    noProxy: ""
  readOnly: false
  replicas: 1
  requests:
    read:
      maxInQueue: 0
      maxRunning: 0
      maxWaitInQueue: 0s
    write:
      maxInQueue: 0
      maxRunning: 0
      maxWaitInQueue: 0s
  storage:
    s3:
      bucket: image-registry-us-east-2-0a598598fc1649d8b96ed91a902b982c-1cbd
      encrypt: true
      keyID: ""
      region: us-east-2
      regionEndpoint: ""
status:
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>次のコマンドを実行すると:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc patch configs.imageregistry.operator.openshift.io/cluster -p '{"spec":{"nodeSelector":{"node-role.kubernetes.io/infra": ""}}}' --type=merge</code></pre>
</div>
</div>
<div class="paragraph">
<p>目的の <code>nodeSelector</code> を追加するために、レジストリ CR の「.spec」を変更します。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>現時点では、イメージ レジストリはそのオペレーター用に別のプロジェクトを使用していません。 演算子とオペランドの両方が <code>openshift-image-registry</code> プロジェクトに格納されています。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>パッチ コマンドを実行すると、レジストリ ポッドがインフラ ノードに移動されていることがわかります。 レジストリーは <code>openshift-image-registry</code> プロジェクトにあります。 以下を十分に迅速に実行した場合：</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pod -n openshift-image-registry</code></pre>
</div>
</div>
<div class="paragraph">
<p>古いレジストリ ポッドが終了し、新しいレジストリ ポッドが開始されることがあります。 レジストリは S3 バケットによってサポートされているため、新しいレジストリ ポッド インスタンスがどのノードに到達するかは問題ではありません。 API を介してオブジェクト ストアと通信しているため、そこに保存されている既存の画像には引き続きアクセスできます。</p>
</div>
<div class="paragraph">
<p>また、デフォルトのレプリカ数は 1 であることに注意してください。実際の環境では、可用性、ネットワーク スループット、またはその他の理由で、これをスケールアップしたい場合があります。</p>
</div>
<div class="paragraph">
<p>レジストリが到達したノード (ルーターのセクションを参照) を見ると、現在はインフラ ワーカーで実行されていることがわかります。</p>
</div>
<div class="paragraph">
<p>最後に、イメージ レジストリの構成の <code>CRD</code> は名前空間ではなく、クラスター スコープであることに注意してください。 OpenShift クラスターごとに 1 つの内部/統合レジストリーしかありません。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring"><a class="anchor" href="#_monitoring"></a>Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>クラスター監視オペレーターは、Prometheus+Grafana+AlertManager クラスター監視スタックの状態のデプロイと管理を担当します。 クラスタの初期インストール時にデフォルトでインストールされます。 そのオペレーターは、<code>openshift-monitoring</code> プロジェクトの <code>ConfigMap</code> を使用して、監視スタックの動作に関するさまざまな調整可能変数と設定を設定します。</p>
</div>
<div class="paragraph">
<p>次の <code>ConfigMap</code> 定義は、モニタリング ソリューションをインフラストラクチャ ノードに再デプロイするように構成します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-monitoring-config
  namespace: openshift-monitoring
data:
  config.yaml: |+
    alertmanagerMain:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
    prometheusK8s:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
    prometheusOperator:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
    grafana:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
    k8sPrometheusAdapter:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
    kubeStateMetrics:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
    telemeterClient:
      nodeSelector:
        node-role.kubernetes.io/infra: ""</code></pre>
</div>
</div>
<div class="paragraph">
<p>インストールの一部として作成される <code>ConfigMap</code> はありません。 これがないと、オペレーターはデフォルト設定を想定します。 <code>ConfigMap</code> がクラスターで定義されていないことを確認します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get configmap cluster-monitoring-config -n openshift-monitoring</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下が表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Error from server (NotFound): configmaps "cluster-monitoring-config" not found</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に、オペレーターは、さまざまな監視スタック コンポーネント用にいくつかの <code>ConfigMap</code> オブジェクトを作成し、それらも表示できます。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get configmap -n openshift-monitoring</code></pre>
</div>
</div>
<div class="paragraph">
<p>次のコマンドを使用して、新しい監視構成を作成できます。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create -f {{ HOME_PATH }}/support/cluster-monitoring-configmap.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>監視ポッドが <code>worker</code> から <code>infra</code>  <code>Nodes</code> に移動するのを次のように確認します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch 'oc get pod -n openshift-monitoring'</code></pre>
</div>
</div>
<div class="paragraph">
<p>もしくは、</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pod -w -n openshift-monitoring</code></pre>
</div>
</div>
<div class="paragraph">
<p>kbd:[Ctrl+C] を押すと終了できます。</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="06-machineset.html">6. MachineSets, Machines, and Nodes</a></span>
  <span class="next"><a href="08-logging.html">8. OpenShift Log Aggregation</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
