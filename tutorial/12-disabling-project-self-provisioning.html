<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: OpenShift Ops Handson</title>
    <link rel="canonical" href="https://rh-open.github.io/openshift-ops-handson/tutorial/12-disabling-project-self-provisioning.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://rh-open.github.io/openshift-ops-handson">OpenShift Ops Handson</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-env-overview.html">2. Environment Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-installation.html">3. Installation and Verification</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-app-basic.html">4. Application Management Basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="05-storage-basic.html">5. Application Storage Basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-machineset.html">6. MachineSets, Machines, and Nodes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-operator.html">7. Infrastructure Nodes and Operators</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-logging.html">8. OpenShift Log Aggregation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-auth.html">9. External (LDAP) Authentication Providers, Users, and Groups</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-monitoring.html">10. OpenShift Monitoring with Prometheus</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#11-project.adoc">11. Project Template, Quota, and Limits</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#12-network.adoc">12. OpenShift Networking and NetworkPolicy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#13-clusterrolebinding.adoc">13. Disabling Project Self-Provisioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#14-clusterresourcequota.adoc">14. Cluster Resource Quotas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="15-taint.html">15. Taints and Tolerations</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/RH-OPEN/openshift-ops-handson/edit/master/documentation/modules/ROOT/pages/12-disabling-project-self-provisioning.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_プロジェクトのセルフプロビジョニングを無効にする"><a class="anchor" href="#_プロジェクトのセルフプロビジョニングを無効にする"></a>プロジェクトのセルフプロビジョニングを無効にする</h2>
<div class="sectionbody">
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>続行する前に、LDAPラボが終わっていることを確認してください。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>OpenShiftはデフォルトで、認証されたユーザーがアプリケーションを論理的に収容するための <strong>Projects</strong> を
作成することができます。この機能により、管理者は「PaaS」（Platform as a Service）モデルの登場によって
広まった「セルフサービス」機能を提供することができます。</p>
</div>
<div class="paragraph">
<p>この機能は、すべての状況に適用できるとは限りません。多くの管理者は、プロジェクトとプロジェクトが作成できる人（誰でも）
を制御できるようにしたいと考えるかもしれません。このような使用例としては、以下のようなものがあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>環境の保護 - 管理者は、自分の知らないところでプロジェクトが作成されることを望まないかもしれません。</p>
</li>
<li>
<p>リソース割り当て - 管理者は、リソース割り当てを細かく制御したい場合があります（例：「オーバーコミットしたくない」）。</p>
</li>
<li>
<p>クオータの柔軟性 - デフォルトのクオータを設定することができますが、管理者はプロジェクトの範囲に応じて追加のクオータを指定（または少なく）することができます。</p>
</li>
<li>
<p>会計とチャージバック - マルチテナントシステムでは、会計とチャージバックを行う必要がある場合があります。</p>
</li>
<li>
<p>一般的な管理コントロール - 管理者は、環境内で何が行われるかを完全にコントロールしたい場合があります。</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>このような制御を行うには、プロジェクトのセルフプロビジョニングを無効にする以外にも方法があります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_背景_プロジェクト"><a class="anchor" href="#_背景_プロジェクト"></a>背景: プロジェクト</h3>
<div class="paragraph">
<p>何を無効にしているのでしょうか？以前のラボで、プロジェクトはアプリケーションのすべてのリソースを
保持する「バケット」のようなものであることを学びました。また、プロジェクトはコラボレーションするために
ユーザーやグループに割り当てることができることも学びました。しかし、プロジェクトとKubernetes Namespaceの違いは何なのでしょうか？</p>
</div>
<div class="paragraph">
<p>プロジェクトはKubernetes Namespaceに直接マッピングされます。また、内部レジストリのネームスペースや
VXLANのVNIDにもマッピングされます。つまり、プロジェクトへのアクセスを許可することは、ユーザーにコラボレーションを
させる以上の効果があるのです。ネットワーク通信、レジストリネームスペースへのアクセス、
Kubernetes Namespace内のオブジェクトへのアクセスを許可することになるのです。</p>
</div>
<div class="sect3">
<h4 id="_clusterrolebindingを検証する"><a class="anchor" href="#_clusterrolebindingを検証する"></a>Clusterrolebindingを検証する</h4>
<div class="paragraph">
<p><code>self-provisioners</code> の <code>clusterrolebinding</code> を調べるには、<strong>kubeadmin</strong> になる必要があります。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>以前のラボで使用した serviceaccount ユーザーを使用することもできます。
<code>kubeadmin</code> とサービスアカウントユーザーはどちらも <code>cluster-admin</code> のロールを持つので、実際には問題ありません。</p>
</div>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u kubeadmin -p {{ KUBEADMIN_PASSWORD }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>self-provisioners` クラスタロールのバインディングの使用状況を <code>oc describe</code> コマンドで確認することができます。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc describe clusterrolebinding.rbac self-provisioners</code></pre>
</div>
</div>
<div class="paragraph">
<p>次のような出力が表示されるはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Name:         self-provisioners
Labels:       &lt;none&gt;
Annotations:  rbac.authorization.kubernetes.io/autoupdate: true
Role:
  Kind:  ClusterRole
  Name:  self-provisioner
Subjects:
  Kind   Name                        Namespace
  ----   ----                        ---------
  Group  system:authenticated:oauth</pre>
</div>
</div>
<div class="paragraph">
<p>ここでは、グループ <code>system:authenticated:oauth</code> (デフォルトでは、認証したすべてのユーザーが属するグループ) が
<code>self-provisioners</code> ロールにバインドされていることを述べています。
このロールは、ユーザーがプロジェクトを作成することを可能にするOpenShiftの組み込みのロールです。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>OpenShiftに付属する様々なロールに興味がある方は、
リンク:https://docs.openshift.com/container-platform/4.9/authentication/using-rbac.html[ロールベースアクセスコントロール（RBAC）^]
のドキュメントで詳細をご覧いただけます。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>設定そのものを見るには、以下を実行してyamlを検査します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get clusterrolebinding.rbac self-provisioners -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>構成は次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  creationTimestamp: "2022-02-14T22:25:08Z"
  name: self-provisioners
  resourceVersion: "10620"
  uid: a0098c02-b9cb-4815-aebd-7dc44ef4d163
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: self-provisioner
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:authenticated:oauth</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_セルフプロビジョンプロジェクトを削除する"><a class="anchor" href="#_セルフプロビジョンプロジェクトを削除する"></a>セルフプロビジョンプロジェクトを削除する</h4>
<div class="paragraph">
<p>self-provisioner`クラスタロールを <code>system:authenticated:oauth</code> グループから
削除するには、そのグループをロールバインドから削除する必要があります。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc patch clusterrolebinding.rbac self-provisioners -p '{"subjects": null}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>自動アップデートにより、クラスタロールはデフォルトの状態にリセットされます。
これを無効にするには、<code>rbac.authorization.kubernetes.io/autoupdate</code> という
アノテーションを実行して <code>false</code> に設定する必要があります。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc patch clusterrolebinding.rbac self-provisioners -p '{ "metadata": { "annotations": { "rbac.authorization.kubernetes.io/autoupdate": "false" } } }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>新しいコンフィギュレーションを表示します。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get clusterrolebinding.rbac self-provisioners -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>これでYAMLに <code>subjects</code> がないはずです。このような感じになるはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "false"
  creationTimestamp: "2022-02-14T22:25:08Z"
  name: self-provisioners
  resourceVersion: "55489"
  uid: a0098c02-b9cb-4815-aebd-7dc44ef4d163
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: self-provisioner</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>fancyuser1</code> としてログインし、プロジェクトを作成してテストしてください。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u fancyuser1 -p Op#nSh1ft
oc new-project fancyuserproject</code></pre>
</div>
</div>
<div class="paragraph">
<p>エラーメッセージが表示されるはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error from server (Forbidden): You may not request a new project via this API.</pre>
</div>
</div>
<div class="paragraph">
<p>次の演習のために <code>kubeadmin</code> ユーザーとしてログインします。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u kubeadmin -p {{ KUBEADMIN_PASSWORD }}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_リクエストメッセージのカスタマイズ"><a class="anchor" href="#_リクエストメッセージのカスタマイズ"></a>リクエストメッセージのカスタマイズ</h4>
<div class="paragraph">
<p>これで、ユーザーがプロジェクトを作成しようとすると、いつでも同じメッセージ
<code>You may not request a new project via this API(このAPIを使用して新しいプロジェクトをリクエストすることはできません)</code> が表示されるようになりました。
このメッセージをカスタマイズして、より意味のある行動喚起を行うことができます。</p>
</div>
<div class="paragraph">
<p>例えば、ユーザーがプロジェクトをリクエストするチケットを送信するようにすることができます。
これは、与えられたテキストを変更して、指示を含めることで実現できます。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc patch --type=merge project.config.openshift.io cluster -p '{"spec":{"projectRequestMessage":"Please visit https://ticket.example.com to request a project"}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, you are adding the <code>projectRequestMessage</code> and the value
<code>Please visit <a href="https://ticket.example.com" class="bare">https://ticket.example.com</a> to request a project</code> to the specification.</p>
</div>
<div class="paragraph">
<p>Before you can see this new message, you&#8217;ll need to wait for the <code>apiserver</code> application
to rollout the changes. This can take some time to rollout, especially on a busy cluster.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sleep 30
oc rollout status -n  openshift-apiserver deploy/apiserver</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで、ユーザがプロジェクトを作成しようとすると、このメッセージが表示されるようになりました。
`fancyuser1`のユーザーになってテストしてみてください。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u fancyuser1 -p Op#nSh1ft</code></pre>
</div>
</div>
<div class="paragraph">
<p>そして、プロジェクトを作成してみましょう。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc new-project fancyuserproject</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のメッセージが表示されるはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Error from server (Forbidden): Please visit https://ticket.example.com to request a project</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_クリーンアップ"><a class="anchor" href="#_クリーンアップ"></a>クリーンアップ</h4>
<div class="paragraph">
<p>次のラボに向けて、`kubeadmin`としてログインしていることを確認してください。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u kubeadmin -p {{ KUBEADMIN_PASSWORD }}</code></pre>
</div>
</div>
<div class="paragraph">
<p>他のラボでは、`self-provisioners`ロールが必要な場合があるので、やったことを元に戻しておきましょう。</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc patch clusterrolebinding.rbac self-provisioners -p '{"subjects":[{"apiGroup":"rbac.authorization.k8s.io","kind":"Group","name":"system:authenticated:oauth"}]}'
oc patch clusterrolebinding.rbac self-provisioners -p '{"metadata":{"annotations":{"rbac.authorization.kubernetes.io/autoupdate":"true"}}}'
oc patch --type=json project.config.openshift.io cluster -p '[{"op": "remove", "path": "/spec/projectRequestMessage"}]'</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
