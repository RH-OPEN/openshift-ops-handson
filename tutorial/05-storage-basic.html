<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: OpenShift Ops Handson</title>
    <link rel="canonical" href="https://rh-open.github.io/openshift-ops-handson/tutorial/05-storage-basic.html">
    <link rel="prev" href="04-app-basic.html">
    <link rel="next" href="06-machineset.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://rh-open.github.io/openshift-ops-handson">OpenShift Ops Handson</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#minikube">Setup Minikube</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="02-env-overview.html">2. Environment Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="03-installation.html">3. Installation and Verification</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="04-app-basic.html">4. Application Management Basics</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="05-storage-basic.html">5. Application Storage Basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-machineset.html">6. MachineSets, Machines, and Nodes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-operator.html">7. Infrastructure Nodes and Operators</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="08-logging.html">8. OpenShift Log Aggregation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="09-auth.html">9. External (LDAP) Authentication Providers, Users, and Groups</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="10-monitoring.html">10. OpenShift Monitoring with Prometheus</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="11-project.html">11. Project Template, Quota, and Limits</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="12-network.html">12. OpenShift Networking and NetworkPolicy</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="13-clusterrolebinding.html">13. Disabling Project Self-Provisioning</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="14-clusterresourcequota.html">14. Cluster Resource Quotas</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="15-taint.html">15. Taints and Tolerations</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Ops Tutorial</a></li>
    <li><a href="05-storage-basic.html">5. Application Storage Basics</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/RH-OPEN/openshift-ops-handson/edit/master/documentation/modules/ROOT/pages/05-storage-basic.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_application_storage_basics"><a class="anchor" href="#_application_storage_basics"></a>Application Storage Basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If a pod in OpenShift needs reliable storage, for example, to host a database,
we would need to supply a <strong>persistent</strong> volume to the pod. This type of
storage outlives the container, i.e. it persists when the pod dies. It
typically comes from an external storage system.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Doing these exercises requires that you already have deployed the application
featured in the Application Management Basics exercises. You should do those
exercises now before continuing.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The <code>mapit</code> application currently doesn&#8217;t leverage any persistent storage. If
the pod dies, so does all the content inside the container.</p>
</div>
<div class="paragraph">
<p>We will talk about this concept in more detail later. But let&#8217;s imagine for a
moment, the <code>mapit</code> application needs persistent storage available under the
<code>/app-storage</code> directory inside the container.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>The directories that make up the container&#8217;s internal filesystem are a blend
of the read-only layers of the container image and the top-most writable
layer that is added as soon as a container instance is started from the
image. The writable layer is disposed of once the container is deleted which
can happen regularly in a dynamic container orchestration environment.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>You should be in the <code>app-management</code> project from the previous lab. To
make sure, run the following command:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project app-management</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_adding_persistent_volume_claims"><a class="anchor" href="#_adding_persistent_volume_claims"></a>Adding Persistent Volume Claims</h3>
<div class="paragraph">
<p>Here&#8217;s how you would instruct OpenShift to create a <code>PersistentVolume</code>
object, which represents external, persistent storage, and have it <strong>mounted</strong>
inside the container&#8217;s filesystem:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc set volume deploy/mapit --add --name=mapit-storage -t pvc --claim-mode=ReadWriteOnce --claim-size=1Gi --claim-name=mapit-storage --mount-path=/app-storage</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>deployment.apps/mapit volume updated</pre>
</div>
</div>
<div class="paragraph">
<p>In the first step a <strong>PersistentVolumeClaim</strong> was created. This object
represents a request for storage of a certain kind, with a certain capacity
from the user to OpenShift.</p>
</div>
<div class="paragraph">
<p>Next the <code>Deployment</code> of <code>mapit</code> is updated to reference this storage
and make it available under the <code>/app-storage</code> directory inside the pod.</p>
</div>
<div class="paragraph">
<p>You can see the new <code>Deployment</code> like this:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get deploy mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will show that a new deployment was created by inspecting the <code>AGE</code> column.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
mapit   1/1     1            1           14m</pre>
</div>
</div>
<div class="paragraph">
<p>Likely, depending when you ran the command, you may or may not see that the new pod is still being spawned:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pod</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME             READY     STATUS              RESTARTS   AGE
mapit-3-ntd9w    1/1       Running             0          9m
mapit-4-d872b    0/1       ContainerCreating   0          5s
mapit-4-deploy   1/1       Running             0          10s</pre>
</div>
</div>
<div class="paragraph">
<p>Take a look at the <code>Deployment</code> now:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc describe deploy mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see there is now both <code>Mounts</code> and <code>Volumes</code> details about the new storage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>...
    Mounts:
      /app-storage from mapit-storage (rw)
  Volumes:
   mapit-storage:
    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName:  mapit-storage
    ReadOnly:   false
...</pre>
</div>
</div>
<div class="paragraph">
<p>But what is happening under the covers?</p>
</div>
</div>
<div class="sect2">
<h3 id="_storage_classes"><a class="anchor" href="#_storage_classes"></a>Storage Classes</h3>
<div class="paragraph">
<p>When OpenShift 4 was first installed, a dynamic storage provider for AWS EBS
was configured. You can see this <code>StorageClass</code> with the following:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get storageclass</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you will see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2 (default)   kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   true                   47m
gp2-csi         ebs.csi.aws.com         Delete          WaitForFirstConsumer   true                   47m</pre>
</div>
</div>
<div class="paragraph">
<p>Any time a request for a volume is made (<code>PersistentVolumeClaim</code>) that
doesn&#8217;t specify a <code>StorageClass</code>, the default will be used. In this case, the
default is an EBS provisioner that will create an EBS GP2 volume of the
requested size (in our example, 1Gi).</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>You&#8217;ll note that there is also a <code>gp2-csi</code>. This implements the
<a href="https://github.com/container-storage-interface/spec">CSI interface</a>,
which stands for "Container Storage Interface". This specification enables
storage vendors to develop their plugins once, and have it work across
various container orchestration systems.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_persistent_volume_claims"><a class="anchor" href="#_persistent_volume_claims"></a>Persistent Volume (Claims)</h3>
<div class="paragraph">
<p>The command you ran earlier referenced a <code>claim</code>. Storage in a Kubernetes
environment uses a system of volume claims and volumes. A user makes a
<code>PersistentVolumeClaim</code> and Kubernetes tries to find a <code>PersistentVolume</code>
that matches. In the case where a volume does not already exist, if there is
a dynamic provisioner that satisfies the claim, a <code>PersistentVolume</code> is
created.</p>
</div>
<div class="paragraph">
<p>Execute the following:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get persistentvolume</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                          STORAGECLASS   REASON   AGE
pvc-4397c6be-9f53-490e-960d-c1b77de6000c   1Gi        RWO            Delete           Bound    app-management/mapit-storage   gp2                     12m</pre>
</div>
</div>
<div class="paragraph">
<p>This is the volume that was created as a result of your earlier claim. Note
that the volume is <strong>bound</strong> to the claim that exists in the <code>app-management</code>
project.</p>
</div>
<div class="paragraph">
<p>Now, execute:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get persistentvolumeclaim -n app-management</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
mapit-storage   Bound    pvc-4397c6be-9f53-490e-960d-c1b77de6000c   1Gi        RWO            gp2            14m</pre>
</div>
</div>
<div class="paragraph">
<p>A rollout is taking place, since the <code>pod</code> needs to mount the created
storage.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc rollout status deployment mapit -n app-management</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_persistent_storage"><a class="anchor" href="#_testing_persistent_storage"></a>Testing Persistent Storage</h3>
<div class="paragraph">
<p>Log on to the pod using the remote-shell capability of the <code>oc</code> client:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc rsh $(oc get pods -l deployment=mapit -o name)</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Being in the container&#8217;s shell session</strong>, list the content of the root
directory from the perspective of the container&#8217;s namespace:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls -ahl /</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see a directory there called <code>/app-storage</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>total 20K
drwxr-xr-x.   1 root  root         81 Apr 12 19:11 .
drwxr-xr-x.   1 root  root         81 Apr 12 19:11 ..
-rw-r--r--.   1 root  root        16K Dec 14  2016 anaconda-post.log
drwxrwsr-x.   3 root  1000570000 4.0K Apr 12 19:10 app-storage <i class="conum" data-value="1"></i><b>(1)</b>
lrwxrwxrwx.   1 root  root          7 Dec 14  2016 bin -&gt; usr/bin
drwxrwxrwx.   1 jboss root         45 Aug  4  2017 deployments
drwxr-xr-x.   5 root  root        360 Apr 12 19:11 dev
drwxr-xr-x.   1 root  root         93 Jan 18  2017 etc
drwxr-xr-x.   2 root  root          6 Nov  5  2016 home
lrwxrwxrwx.   1 root  root          7 Dec 14  2016 lib -&gt; usr/lib
lrwxrwxrwx.   1 root  root          9 Dec 14  2016 lib64 -&gt; usr/lib64
drwx------.   2 root  root          6 Dec 14  2016 lost+found
drwxr-xr-x.   2 root  root          6 Nov  5  2016 media
drwxr-xr-x.   2 root  root          6 Nov  5  2016 mnt
drwxr-xr-x.   1 root  root         19 Jan 18  2017 opt
dr-xr-xr-x. 183 root  root          0 Apr 12 19:11 proc
dr-xr-x---.   2 root  root        114 Dec 14  2016 root
drwxr-xr-x.   1 root  root         21 Apr 12 19:11 run
lrwxrwxrwx.   1 root  root          8 Dec 14  2016 sbin -&gt; usr/sbin
drwxr-xr-x.   2 root  root          6 Nov  5  2016 srv
dr-xr-xr-x.  13 root  root          0 Apr 10 14:34 sys
drwxrwxrwt.   1 root  root         92 Apr 12 19:11 tmp
drwxr-xr-x.   1 root  root         69 Dec 16  2016 usr
drwxr-xr-x.   1 root  root         41 Dec 14  2016 var</pre>
</div>
</div>
<div class="paragraph">
<p><strong>&lt;1&gt;</strong> This is where the persistent storage appears inside the container</p>
</div>
<div class="paragraph">
<p>Amazon EBS volumes are read-write-once. In other words, because they are
block storage, they may only be attached to one EC2 instance at a time, which
means that only one container can use an EBS-based <code>PersistentVolume</code> at a
time. In other words: read-write-once.</p>
</div>
<div class="paragraph">
<p>Execute the following inside the remote shell session:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">echo "Hello World from OpenShift" &gt; /app-storage/hello.txt
exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, make sure your file is present:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc rsh $(oc get pods -l deployment=mapit -o name) cat /app-storage/hello.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, to verify that persistent storage really works, delete your pod:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete pods -l deployment=mapit &amp;&amp; oc rollout status deployment/mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>deployment</code> automatically rollsout a new <code>pod</code>:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your new pod is ready and running. Now that it&#8217;s running, check the file:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc rsh $(oc get pods -l deployment=mapit -o name) cat /app-storage/hello.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s still there. In fact, the new pod may not even be running on the same
node as the old pod, which means that, under the covers, Kubernetes and
OpenShift automatically attached the real, external storage to the right
place at the right time.</p>
</div>
<div class="paragraph">
<p>If you needed read-write-many storage, file-based storage solutions can
provide it. OpenShift Container Storage is a hyperconverged storage solution
that can run inside OpenShift and provide file, block and even object storage
by turning locally attached storage devices into storage pools and then
creating volumes out of them.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-app-basic.html">4. Application Management Basics</a></span>
  <span class="next"><a href="06-machineset.html">6. MachineSets, Machines, and Nodes</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
